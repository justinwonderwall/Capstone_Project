
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UWA CSP Reconciliation – Cluster × FOE (2024)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> .num{font-variant-numeric:tabular-nums;} </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <h1 class="text-3xl font-bold tracking-tight">UWA CSP Reconciliation – Cluster × FOE (2024)</h1>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <section id="kpis" class="grid grid-cols-1 md:grid-cols-4 gap-4"></section>

    <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
      <div class="flex flex-col md:flex-row md:items-end gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700">Funding Cluster</label>
          <select id="filterCluster" class="mt-1 block w-52 rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
            <option value="">All</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">FOE Code</label>
          <input id="filterFoe" type="text" placeholder="e.g. 060101" class="mt-1 w-40 rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">% Threshold</label>
          <input id="filterPct" type="number" value="10" min="0" class="mt-1 w-24 rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"/>
        </div>
        <div class="md:ml-auto">
          <button id="btnApply" class="inline-flex items-center px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-600">Apply</button>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Cluster</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">FOE Code</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">FOE Name</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600">Total EFTSL</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600">UWA $</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600">Gov (Indexed) $</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600">Δ $</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600">Δ %</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600">Flag</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-slate-100 bg-white"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const seed = [
      {cluster: "Funding Cluster 4", foe_code: "060100", foe_name: "Medical Studies", eftsl: 41.78, uwa: 19050066.27, gov: 19000000.00},
      {cluster: "Funding Cluster 3", foe_code: "010913", foe_name: "Human Biology", eftsl: 9.88,  uwa: 7410546.50,  gov: 7300000.00},
      {cluster: "Funding Cluster 2", foe_code: "010101", foe_name: "Mathematics",    eftsl: 12.67, uwa: 6238198.84,  gov: 6100000.00},
      {cluster: "Funding Cluster 4", foe_code: "060701", foe_name: "Dentistry",      eftsl: 6.35,  uwa: 5015175.10,  gov: 5000000.00},
      {cluster: "Funding Cluster 3", foe_code: "039999", foe_name: "Engineering, n.e.c.", eftsl: 15.66, uwa: 3724708.50, gov: 3600000.00},
    ];

    function fmtCurrency(v){ return (v).toLocaleString('en-AU', {style:'currency', currency:'AUD', maximumFractionDigits:0}); }
    function fmtNum(v){ return Number(v).toLocaleString('en-AU', {maximumFractionDigits:2}); }

    const clusters = Array.from(new Set(seed.map(d => d.cluster))).sort();
    const sel = document.getElementById('filterCluster');
    clusters.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });

    function computeRows(data){
      return data.map(d => {
        const delta = d.uwa - d.gov;
        const pct = d.gov === 0 ? 0 : (delta / d.gov) * 100;
        return {...d, delta, pct};
      });
    }

    function renderKpis(rows){
      const totalEftsl = rows.reduce((a,b)=>a+b.eftsl,0);
      const totalUwa   = rows.reduce((a,b)=>a+b.uwa,0);
      const totalGov   = rows.reduce((a,b)=>a+b.gov,0);
      const gap        = totalUwa - totalGov;
      const pct        = totalGov === 0 ? 0 : gap / totalGov * 100;

      const boxes = [
        {title:"Total EFTSL", value: fmtNum(totalEftsl)},
        {title:"UWA (calc.)", value: fmtCurrency(totalUwa)},
        {title:"Gov (indexed)", value: fmtCurrency(totalGov)},
        {title:"Gap", value: `${fmtCurrency(gap)} (${pct.toFixed(1)}%)`},
      ];

      const wrap = document.getElementById('kpis');
      wrap.innerHTML = '';
      boxes.forEach(b => {
        const div = document.createElement('div');
        div.className = "bg-white border border-slate-200 rounded-xl p-4 shadow-sm";
        div.innerHTML = `<div class="text-sm text-slate-500">${b.title}</div>
                         <div class="mt-1 text-xl font-semibold num">${b.value}</div>`;
        wrap.appendChild(div);
      });
    }

    function renderTable(rows){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const flag = Math.abs(r.pct) >= (Number(document.getElementById('filterPct').value) || 0);
        tr.innerHTML = `
          <td class="px-4 py-2 text-sm">${r.cluster}</td>
          <td class="px-4 py-2 text-sm font-mono">${r.foe_code}</td>
          <td class="px-4 py-2 text-sm">${r.foe_name}</td>
          <td class="px-4 py-2 text-sm text-right num">${fmtNum(r.eftsl)}</td>
          <td class="px-4 py-2 text-sm text-right num">${fmtCurrency(r.uwa)}</td>
          <td class="px-4 py-2 text-sm text-right num">${fmtCurrency(r.gov)}</td>
          <td class="px-4 py-2 text-sm text-right num ${r.delta>=0?'text-emerald-700':'text-rose-700'}">${fmtCurrency(r.delta)}</td>
          <td class="px-4 py-2 text-sm text-right num ${r.pct>=0?'text-emerald-700':'text-rose-700'}">${r.pct.toFixed(1)}%</td>
          <td class="px-4 py-2 text-sm text-right">${flag ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-rose-100 text-rose-800">⚠︎ Flag</span>' : ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function applyFilters(){
      const c = document.getElementById('filterCluster').value;
      const f = document.getElementById('filterFoe').value.trim();
      let rows = computeRows(seed);
      if(c) rows = rows.filter(r => r.cluster === c);
      if(f) rows = rows.filter(r => r.foe_code.includes(f));
      renderKpis(rows);
      renderTable(rows);
    }

    document.getElementById('btnApply').addEventListener('click', applyFilters);
    applyFilters();
  </script>
</body>
</html>
